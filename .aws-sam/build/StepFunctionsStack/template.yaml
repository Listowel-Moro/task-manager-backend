AWSTemplateFormatVersion: '2010-09-09'
Description: Step Functions Resources for Task Management System Backend
Parameters:
  TaskAssignmentNotificationTopicArn:
    Type: String
    Description: SNS Task Assignment Notification Topic ARN
  TaskDeadlineNotificationTopicArn:
    Type: String
    Description: SNS Task Deadline Notification Topic ARN
  ClosedTasksNotificationTopicArn:
    Type: String
    Description: SNS Closed Tasks Notification Topic ARN
Resources:
  StepFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: states.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: StepFunctionPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - sns:Subscribe
            - sns:Publish
            - dynamodb:UpdateItem
            Resource: '*'
      Tags:
      - Key: Component
        Value: StepFunctions
  TeamMemberSubscriptionStepFunction:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      DefinitionString:
        Fn::Sub: "{\n  \"StartAt\": \"ParallelSubscribe\",\n  \"States\": {\n    \"\
          ParallelSubscribe\": {\n      \"Type\": \"Parallel\",\n      \"Branches\"\
          : [\n        {\n          \"StartAt\": \"SubscribeAssignment\",\n      \
          \    \"States\": {\n            \"SubscribeAssignment\": {\n           \
          \   \"Type\": \"Task\",\n              \"Resource\": \"arn:aws:states:::aws-sdk:sns:subscribe\"\
          ,\n              \"Parameters\": {\n                \"TopicArn\": \"${TaskAssignmentNotificationTopicArn}\"\
          ,\n                \"Protocol\": \"email\",\n                \"Endpoint.$\"\
          : \"$.email\",\n                \"Attributes\": {\n                  \"\
          FilterPolicy\": \"{\\\"user_id\\\": [\\\"$.user_id\\\"]}\"\n           \
          \     }\n              },\n              \"End\": true\n            }\n\
          \          }\n        },\n        {\n          \"StartAt\": \"SubscribeDeadline\"\
          ,\n          \"States\": {\n            \"SubscribeDeadline\": {\n     \
          \         \"Type\": \"Task\",\n              \"Resource\": \"arn:aws:states:::aws-sdk:sns:subscribe\"\
          ,\n              \"Parameters\": {\n                \"TopicArn\": \"${TaskDeadlineNotificationTopicArn}\"\
          ,\n                \"Protocol\": \"email\",\n                \"Endpoint.$\"\
          : \"$.email\",\n                \"Attributes\": {\n                  \"\
          FilterPolicy\": \"{\\\"user_id\\\": [\\\"$.user_id\\\"]}\"\n           \
          \     }\n              },\n              \"End\": true\n            }\n\
          \          }\n        },\n        {\n          \"StartAt\": \"SubscribeClosed\"\
          ,\n          \"States\": {\n            \"SubscribeClosed\": {\n       \
          \       \"Type\": \"Task\",\n              \"Resource\": \"arn:aws:states:::aws-sdk:sns:subscribe\"\
          ,\n              \"Parameters\": {\n                \"TopicArn\": \"${ClosedTasksNotificationTopicArn}\"\
          ,\n                \"Protocol\": \"email\",\n                \"Endpoint.$\"\
          : \"$.email\",\n                \"Attributes\": {\n                  \"\
          FilterPolicy\": \"{\\\"assignee_id\\\": [\\\"$.user_id\\\"]}\"\n       \
          \         }\n              },\n              \"End\": true\n           \
          \ }\n          }\n        }\n      ],\n      \"End\": true\n    }\n  }\n\
          }\n"
      RoleArn:
        Fn::GetAtt:
        - StepFunctionRole
        - Arn
      Tags:
      - Key: Component
        Value: StepFunctions
Outputs:
  TeamMemberSubscriptionStepFunctionArn:
    Description: ARN of the Team Member Subscription Step Function
    Value:
      Ref: TeamMemberSubscriptionStepFunction
